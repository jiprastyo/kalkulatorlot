<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Kalkulator Lot</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.57.0/build/stlite.css" />
    <style>
      /* CSS untuk menyembunyikan spinner/panah standar browser di input angka */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
      }
      input[type=number] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.57.0/build/stlite.js"></script>
    <script>
      stlite.mount(
        {
          requirements: ["pandas"], // feedparser DIHAPUS
          entrypoint: "app.py",
          files: {
            "app.py": `
import streamlit as st
import pandas as pd
import xml.etree.ElementTree as ET
from pyodide.http import open_url

# --- Fungsi Utility ---
def save_settings(equity, risk):
    st.session_state['saved_equity'] = equity
    st.session_state['saved_risk'] = risk

# Inisialisasi State
if 'saved_equity' not in st.session_state:
    st.session_state['saved_equity'] = 10000000.0
if 'saved_risk' not in st.session_state:
    st.session_state['saved_risk'] = 1.0

# --- Layout Aplikasi ---
st.title("Kalkulator Lot")

col1, col2 = st.columns(2)

with col1:
    equity = st.number_input("Total Modal (IDR)", 
                             value=float(st.session_state['saved_equity']), 
                             step=100000.0, 
                             format="%.0f")
    ticker = st.text_input("Kode Saham (Contoh: MINA)", value="").upper()

with col2:
    risk_pct = st.number_input("Risk per Trade (%)", 
                               value=float(st.session_state['saved_risk']), 
                               step=0.1, 
                               format="%.1f")
    
    if st.button("ðŸ’¾ Simpan Modal & Risiko"):
        save_settings(equity, risk_pct)
        st.toast("Disimpan sementara di sesi ini!")

st.divider()

# --- Kalkulator ---
col_a, col_b = st.columns(2)
with col_a:
    price = st.number_input("Harga Beli (Entry)", value=1000, step=1)
with col_b:
    stop_loss_price = st.number_input("Harga Stop Loss", value=950, step=1)

risk_amount = equity * (risk_pct / 100)
risk_per_share = price - stop_loss_price

if risk_per_share > 0:
    total_shares = risk_amount / risk_per_share
    total_lots = int(total_shares / 100)
    total_investment = total_lots * 100 * price
    
    st.subheader("Hasil Analisis")
    res1, res2, res3 = st.columns(3)
    res1.metric("Max Risk", f"Rp {risk_amount:,.0f}")
    res2.metric("Jumlah Lot", f"{total_lots} Lot")
    res3.metric("Total Beli", f"Rp {total_investment:,.0f}")
else:
    st.error("Harga Stop Loss harus lebih rendah dari Harga Beli.")

st.divider()

# --- Fitur Berita (Menggunakan XML Parsing Standard) ---
if ticker:
    st.subheader(f"10 Berita Terbaru: {ticker}")
    try:
        # URL RSS Google News
        rss_url = f"https://news.google.com/rss/search?q={ticker}+stock+indonesia&hl=id&gl=ID&ceid=ID:id"
        
        # Fetch menggunakan pyodide.http (Aman untuk browser)
        response_content = open_url(rss_url).read()
        
        # Parsing XML manual tanpa feedparser
        root = ET.fromstring(response_content)
        
        news_data = []
        # Loop cari item berita
        for item in root.findall(".//item")[:10]:
            title = item.find("title").text if item.find("title") is not None else "No Title"
            link = item.find("link").text if item.find("link") is not None else "#"
            pubDate = item.find("pubDate").text if item.find("pubDate") is not None else ""
            
            # Format tanggal sederhana
            date_display = pubDate[:16] if len(pubDate) > 16 else pubDate
            
            news_data.append({
                "Tanggal": date_display,
                "Judul": title,
                "Link": link
            })
        
        if news_data:
            # Tampilkan sebagai Dataframe dengan Column Config untuk Link
            df_news = pd.DataFrame(news_data)
            st.dataframe(
                df_news,
                column_config={
                    "Link": st.column_config.LinkColumn("Baca Berita")
                },
                hide_index=True,
                use_container_width=True
            )
        else:
            st.warning("Tidak ada berita ditemukan.")
            
    except Exception as e:
        st.error(f"Gagal mengambil berita. Pastikan koneksi internet stabil. Error: {e}")
            `,
          },
        },
        document.getElementById("root")
      );
    </script>
  </body>
</html>
